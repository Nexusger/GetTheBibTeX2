@using System.Web.Optimization
@using Dblp.WebUi.Helpers
@{
    ViewBag.Title = "Durchsuchen der Dblp";
}

<h2>Durchsuchen der DBLP</h2>
@using (Html.BeginForm("AddItem", "ShoppingCart"))
{
    @Html.InputWithGlyphicon()
    @Html.Hidden("dblpKey")
    <div id="summary" class="panel panel-primary">
        <div class="panel-heading" data-bind="text: model.ConferenceTitle">Konferenz oder Person</div>
        <div class="panel-body">
            <table class="table table-striped table-condensed">
                <thead>
                    <tr>
                        <th></th>
                        <th>Konferenz</th>
                        <th>Titel</th>
                        <th>Autoren</th>
                        <th>Key (für Debuggen)</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: model.SubConferences">
                    <tr class="info">
                        <td><input type="checkbox" /></td>
                        <td data-bind="text: Title">Der Titel</td>
                        <td colspan="2">Leer</td>
                        <td data-bind="text: Key"></td>
                    </tr>
                    <!-- ko foreach: Publications -->
                    <tr>
                        <td><input type="checkbox" data-bind="click:toggleCheckbox, checked:selected" /></td>
                        <td></td>
                        <td colspan="2" data-bind="text: Title">Der Titel</td>
                        <td data-bind="text: Key"></td>
                    </tr>
                    <!-- /ko -->
                </tbody>
            </table>
        </div>
    </div>
}

@section JavaScript
{
    @Scripts.Render("~/bundles/ko") 
    <script type="text/javascript" src="@Url.Content("/Scripts/site.js")"></script>
    <script type="text/javascript">
        var model = {
            ConferenceTitle: ko.observable(),
            Key: ko.observable(),
            SubConferences: ko.observableArray(),
        };

        function sendAjaxRequest(httpMethod, callback, url) {
            $.ajax("/api/Conference/GetConference" + (url ? "/" + url : "s"), { type: httpMethod, success: callback });
        }

        function getAllItems(key) {
            sendAjaxRequest("GET", function(data) {

                model.ConferenceTitle(data.ConferenceTitle);
                model.Key(data.Key);

                model.SubConferences.removeAll();
                for (var i = 0; i < data.SubConferences.length; i++) {
                    //model.SubConferences.push({key:data.SubConferences[i],selected:true});
                    var publicationsInSubConference = ko.observableArray();
                    if (data.SubConferences[i].Publications != null) {
                        for (var j = 0; j < data.SubConferences[i].Publications.length; j++) {

                            var currentPublication = data.SubConferences[i].Publications[j];

                            publicationsInSubConference.push(
                            {
                                Key: currentPublication.Key,
                                Title: currentPublication.Title,
                                Authors: currentPublication.Authors,
                                selected: ko.observable(false)
                            });
                        }
                        model.SubConferences.push(
                        {
                            Key: data.SubConferences[i].Key,
                            selected: ko.observable(false),
                            Title: data.SubConferences[i].Title,
                            Publications: publicationsInSubConference
                        });
                    }
                }
            }, key);
        }

        function toggleCheckbox() {
            var self = this;
            if (self.selected() == true) {
                RemoveItemFromCart(self);
            } else {
                AddItemToCart(self);
            }
            return true;
        }

        function AddItemToCart(self) {
            $.ajax("/ShoppingCart/AddKey/" + self.Key, {
                type: "POST",
                success: function() {
                    self.selected(true);
                }
            });
            return true;
        }

        function RemoveItemFromCart(self) {
            $.ajax("/ShoppingCart/DeleteKey/" + self.Key, {
                type: "DELETE",
                success: function() {
                    self.selected(false);
                }
            });
            return true;
        }

        //function removeItem(item) {
        //     sendAjaxRequest("DELETE", function() {
        //          getAllItems();
        //     }, item.ReservationId);
        //}
        $(document).ready(function() {
            //getAllItems();
            ko.applyBindings(model);
        });
    </script>
}

